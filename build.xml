<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." default="bindist" name="jFreeRails">
    
   <description>The aim of the FreeRails project is to create a fun game based off the RailRoad Tycoon and RailRoad Tycoon II games.</description>



   <target depends="properties" name="init">
      <tstamp/>

      <property location="src" name="src"/>

      <property location="build" name="build"/>

      <property location="dist" name="dist"/>

      <property location="javadoc" name="doc"/>

      <property location="temp" name="temp"/>
   </target>

   <target depends="init" description="Make build directories" name="mkdirs">
      <tstamp/>

      <mkdir dir="${build}"/>

      <mkdir dir="${dist}/lib"/>
      
      <mkdir dir="${dist}/latest"/>
      
   </target>

   <target if="eclipse.running" name="properties">
      <property name="build.compiler" value="org.eclipse.jdt.core.JDTCompilerAdapter"/>
   </target>

   <target depends="init" description="Copy data files" name="copydata">
      <copy todir="${build}/jfreerails">
         <fileset dir="${src}/jfreerails">
            <include name="**/*.xml"/>

            <include name="**/*.png"/>

            <include name="**/*.dtd"/>
            
             <include name="**/*.gif"/>
             <include name="client/view/game_controls.html"/>             
             <include name="**/*.htm"/>
         </fileset>
      </copy>

      <copy todir="${build}">
         <fileset dir=".">
            <include name="README"/>

            <include name="TODO"/>

            <include name="ChangeLog"/>
         </fileset>
      </copy>
      
      <replace file="${build}/README" token="@version@" value="${DSTAMP}-${TSTAMP}"/>
      <replace file="${build}/jfreerails/client/view/about.htm" token="@version@" value="${DSTAMP}-${TSTAMP}"/>
      
   </target>

   <target depends="copydata" description="Build everything except JUnit test-classes" name="compile">
      <javac destdir="${build}" fork="true" source="1.4" srcdir="${src}">
         <exclude name="**/*Test.java"/>
         <exclude name="**/*TestCase.java"/>         
      </javac>
   </target>

   <target depends="copydata" description="Build everything including JUnit    test-classes. Include debugging symbols" name="debugcompile">
      <javac debug="true" destdir="${build}" fork="true" source="1.4" srcdir="${src}"/>
   </target>

   <target depends="debugcompile" description="Run all junit tests" name="runtests">
      <junit haltonfailure="yes" printsummary="yes">
         <classpath>
            <pathelement location="${build}"/>

            <pathelement path="${java.class.path}"/>
         </classpath>

         <formatter type="brief" usefile="no"/>

         <batchtest fork="yes">
            <fileset dir="${build}">
               <include name="**/*Test.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <target depends="compile, mkdirs" description="Generate binary distribution" name="bindist">
      <jar basedir="${build}" destfile="${dist}/lib/jFreeRails-${DSTAMP}-${TSTAMP}-bin.jar">
         <manifest>
            <attribute name="Main-Class" value="jfreerails.launcher.Launcher"/>
         </manifest>
      </jar>
      <!-- Replace current latest with the jar file we have just created. -->
      	<delete>      		
      		<fileset dir="${dist}/latest/" includes="jFreeRails-*-bin.jar"/>      		
      	</delete>      	      
      <copy file="${dist}/lib/jFreeRails-${DSTAMP}-${TSTAMP}-bin.jar" todir="${dist}/latest"/>      
      
   </target>

   <target depends="mkdirs" description="Generate source distribution" name="srcdist">
      <jar basedir="." destfile="${dist}/lib/jFreeRails-${DSTAMP}-${TSTAMP}-src.jar">
         <include name="src/**/*.java"/>
         
         <include name="src/**/*.html"/>
         
         <include name="src/**/*.form"/>

         <include name="build.xml"/>

         <include name="src/jfreerails/**/*.xml"/>

         <include name="src/**/*.png"/>

         <include name="src/**/*.dtd"/>
         
         <include name="src/**/*.gif"/>

         <include name="README"/>

         <include name="TODO"/>

         <include name="ChangeLog"/>
      </jar>
      
       <!-- Replace current latest with the jar file we have just created. -->
      	<delete>      		
      		<fileset dir="${dist}/latest/" includes="jFreeRails-*-src.jar"/>      		
      	</delete>      	      
      <copy file="${dist}/lib/jFreeRails-${DSTAMP}-${TSTAMP}-src.jar" todir="${dist}/latest"/>      
   </target>

   <target depends="init" description="Clean up build and distribution" name="clean">
      <delete dir="${build}"/>

      <delete dir="${dist}/latest"/>

      <delete dir="${doc}"/>

      <delete dir="${temp}"/>
            
      <!-- also delete any class files under the src directory -->      
      <delete>
    	<fileset dir="${src}" includes="**/*.class"/>
  	 </delete>             
   </target>

   <target depends="mkdirs, compile" description="Test run based on compile" name="run">
      <java classname="jfreerails.RunFreerails" fork="true">
         <classpath>
            <pathelement path="${build}"/>
         </classpath>
      </java>
   </target>

   <target depends="bindist" description="Test run based on bindist" name="rundist">
      <java fork="true" jar="${dist}/lib/jFreeRails-${DSTAMP}-${TSTAMP}-bin.jar"/>
   </target>

   <target depends="mkdirs, init" name="javadoc">
      <javadoc Private="true" author="true" destdir="${doc}" overview="${src}/overview.html" source="1.4" use="true" version="true" windowtitle="JFreerails API - build ${DSTAMP}">
         <fileset defaultexcludes="yes" dir="${src}">
            <include name="**/*.java"/>
            <exclude name="**/*Test.java"/>             
         </fileset>
      </javadoc>
	   <!-- now copy the html	-->
	  <copy todir="${doc}">
         <fileset dir="${src}">
            <include name="**/*.html"/>
			<include name="**/*.htm"/>
			
			<!--Don't copy these since the javadoc tool processes them -->
            <exclude name="**/overview.html"/> 
			<exclude name="**/package.html"/>      
         </fileset>
      </copy>
   </target>

  
   <target depends="javadoc" description="Jar up javadoc" name="jar_doc">
      <jar basedir="." destfile="${dist}/lib/jFreeRails-${DSTAMP}-${TSTAMP}-javadoc.jar">
         <include name="javadoc/**/*"/>
      </jar>
      <!-- Replace current latest with the jar file we have just created. -->
      <delete>      		
      		<fileset dir="${dist}/latest/" includes="jFreeRails-*-javadoc.jar"/>      		
      	</delete>      	      
      <copy file="${dist}/lib/jFreeRails-${DSTAMP}-${TSTAMP}-javadoc.jar" todir="${dist}/latest"/>            
   </target>

   <target depends="jar_doc, bindist, srcdist" description="Create binary, source, and javadoc jars" name="all_dist">
   </target>

<!-- Requires that NetComponents.jar is in ant/lib -->
   <target depends="all_dist" description="Upload source, binary, and javadocs jar files to sourcforge" name="upload">
      <ftp binary="yes" password="me@myorg.com" remotedir="/incoming" server="upload.sourceforge.net" userid="anonymous">
         <fileset dir="${dist}/latest">
            <include name="*.jar"/>
         </fileset>
      </ftp>
   </target>

	<target depends="mkdirs, init" description="Copies the files world/**/*java  to dist/world_scr" name="copy_world_src">
		<delete dir="${dist}/world_scr"/>
		<mkdir dir="${dist}/world_scr"/>
      <copy todir="${dist}/world_scr">
         <fileset dir="${src}">
            <include name="jfreerails/world/**/*.java"/>
            <include name="jfreerails/util/*.java"/>
            <include name="it/unimi/dsi/fastUtil/*.java"/>
            <exclude name="**/*Test.java"/>
             <exclude name="**/*TestCase.java"/> 
         </fileset>
      </copy>
     </target>
     
     <!-- Useful for running code metrics and audits without unit tests distorting the results. -->
     <target depends="mkdirs, init" description="Copies all *.java except *Test.java to dist/src_excluding_tests" name="copy_src_excluding_tests">
		<delete dir="${dist}/src_excluding_tests"/>
		<mkdir dir="${dist}/src_excluding_tests"/>
      <copy todir="${dist}/src_excluding_tests">
         <fileset dir="${src}">
            <include name="**/*.java"/>            
            <exclude name="**/*Test.java"/>
            <exclude name="**/*TestCase.java"/>
         </fileset>
      </copy>
     </target>
                    
   <!-- You can download jalopy from: http://jalopy.sourceforge.net/  -->
   <target depends="compile" description="formats the source code files using jalopy" name="format">    
   	<taskdef classname="de.hunsicker.jalopy.plugin.ant.AntPlugin" name="jalopy"/>
    <jalopy convention="freerails_code_convention.xml" history="file" historymethod="adler32">
      <fileset dir="${src}">
        <include name="**/*.java"/>
        <!-- Exclude forms since formatting may break the protected code regions. -->
         <exclude name="**/*Form.java"/>                  
         <exclude name="jfreerails/client/view/**"/>   
         <exclude name="jfreerails/launcher/**"/>    
         <exclude name="**/ProgressJPanel.java"/>
         <exclude name="**/RunFreerailsJFrame.java"/>
	     <exclude name="**/StartUpOptionsJPanel.java"/>
         <exclude name="**/ClientJFrame.java"/>         
         <exclude name="**/DialogueBoxTester.java"/>       
         
          <!-- Exclude GenerateDependenciesXmlAndHtml since line splitting makes it less readable. -->
         <exclude name="**/GenerateDependenciesXmlAndHtml.java"/>                     
      </fileset>
    </jalopy>
  </target>
   
</project>
